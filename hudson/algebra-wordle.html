<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Algebra Wordle</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .game-container {
      width: min(640px, 100vw - 32px);
      padding: 24px;
      border-radius: 18px;
      background: radial-gradient(circle at top, #1e293b, #020617);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.9);
    }
    h1 {
      text-align: center;
      margin: 0 0 4px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 20px;
    }
    .subtitle {
      text-align: center;
      margin-bottom: 12px;
      font-size: 13px;
      color: #9ca3af;
    }

    /* Difficulty toggle */
    .difficulty-toggle {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-bottom: 10px;
    }
    .difficulty-toggle button {
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 5px 13px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.8);
      color: #e5e7eb;
      box-shadow: none;
      transition: background 0.12s ease, border-color 0.12s ease, transform 0.08s ease, box-shadow 0.08s ease;
    }
    .difficulty-toggle button:hover {
      background: #020617;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.9);
    }
    .difficulty-toggle button.active {
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      border-color: transparent;
      color: #022c22;
      box-shadow: 0 10px 25px rgba(56, 189, 248, 0.35);
      transform: translateY(-1px);
    }

    #puzzle-info {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 14px;
      padding: 10px 14px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.9);
      margin-bottom: 16px;
    }
    #puzzle-info span.value {
      font-weight: 600;
      color: #fbbf24;
    }

    .board {
      display: grid;
      gap: 6px;
      margin-bottom: 14px;
    }
    .row {
      display: grid;
      gap: 6px;
    }
    .tile {
      height: 44px;
      border-radius: 10px;
      border: 1px solid #1f2933;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 600;
      text-transform: none;
      background: #020617;
      color: #e5e7eb;
      box-shadow: 0 2px 0 rgba(15, 23, 42, 0.7);
      transform-origin: center;
    }
    .tile.faded {
      opacity: 0.35;
    }
    .tile.correct {
      background: #22c55e;
      border-color: #16a34a;
      color: #052e16;
    }
    .tile.present {
      background: #eab308;
      border-color: #a16207;
      color: #422006;
    }
    .tile.absent {
      background: #111827;
      border-color: #020617;
      color: #4b5563;
    }

    /* Animated reveal for tiles */
    .tile.reveal {
      animation: flip-reveal 0.4s ease forwards;
    }
    @keyframes flip-reveal {
      0% {
        transform: rotateX(0deg);
      }
      50% {
        transform: rotateX(90deg);
      }
      51% {
        transform: rotateX(90deg);
      }
      100% {
        transform: rotateX(0deg);
      }
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 4px;
    }
    .controls label {
      font-size: 13px;
      color: #9ca3af;
    }
    #guess-input {
      flex: 1;
      min-width: 0;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      font-size: 15px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }
    #guess-input:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
      background: #020617;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      box-shadow: 0 10px 25px rgba(34, 197, 94, 0.4);
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.1s ease;
      white-space: nowrap;
    }
    button:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 14px 32px rgba(34, 197, 94, 0.55);
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 0 6px 15px rgba(34, 197, 94, 0.35);
    }
    button.secondary {
      background: transparent;
      border: 1px solid #4b5563;
      color: #e5e7eb;
      box-shadow: none;
    }
    button.secondary:hover {
      background: #020617;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.9);
    }
    button.hidden {
      display: none;
    }

    .helper {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 6px;
    }
    #eval-info {
      font-size: 13px;
      margin-bottom: 8px;
      color: #e5e7eb;
    }
    #eval-info span.bad {
      color: #f97373;
    }
    #eval-info span.good {
      color: #4ade80;
    }

    .message {
      min-height: 18px;
      font-size: 13px;
      color: #d1d5db;
      margin-bottom: 8px;
    }
    .message strong {
      color: #fbbf24;
    }

    .shake {
      animation: shake 0.18s linear 0s 2;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }

    .hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    @media (max-width: 480px) {
      .tile {
        height: 38px;
        font-size: 18px;
      }
      h1 {
        font-size: 18px;
      }
      .game-container {
        padding: 18px;
      }
    }
  </style>
</head>
<body>
<div class="game-container">
  <h1>Algebra Wordle</h1>
  <div class="subtitle">Use the given digits, add operators & parentheses, and hit the target.</div>

  <div class="difficulty-toggle">
    <button data-diff="easy" class="active">Easy</button>
    <button data-diff="medium">Medium</button>
    <button data-diff="hard">Hard</button>
  </div>

  <div id="puzzle-info">
    <div>Digits: <span id="numbers" class="value"></span></div>
    <div>Target: <span id="target" class="value"></span></div>
  </div>

  <div id="board" class="board"></div>

  <div class="controls">
    <label for="guess-input">Your expression:</label>
    <input id="guess-input" type="text" autocomplete="off" spellcheck="false"
           placeholder="Example: 3*(4+5)-2">
    <button id="submit-btn">Enter</button>
  </div>

  <div class="helper">
    Must use digits in this order, once each. Allowed symbols: <code>+ - * / ^ ( )</code>.
  </div>
  <div id="eval-info"></div>
  <div id="message" class="message"></div>

  <button id="new-game-btn" class="secondary hidden">New Puzzle</button>

  <div class="hint">
    ðŸŸ© = correct symbol & spot, ðŸŸ¨ = in expression but moved, â¬œ = not used in the hidden expression.
    You also win if you hit the target value with a different valid expression!
  </div>
</div>

<script>
  // --- Puzzle definitions by difficulty --------------------------------------
  // Easy: shorter, mostly + and *, light parentheses.
  // Medium: more parentheses, mixing + - * /, slightly longer.
  // Hard: longer, nested parentheses, division & exponent.
  const PUZZLES = {
    easy: [
      '3*(4+5)-2',
      '5+4*3-2',
      '2*(3+4)',
      '6*3-5',
      '7+(8-5)*2',
      '4*(3+2)',
      '(5+1)*3-2',
      '2+3*4',
      '(8-3)*2+1',
      '9-3*2'
    ],
    medium: [
      '(8/4+3)*5',
      '6*(7-5)+4',
      '(9-3)*(2+1)',
      '7*(6-4)+3',
      '2*(5+6)-7',
      '(8-3)*4+2',
      '9-(3*(2+1))',
      '4*(5+2)-3',
      '(7+5)/4*6',
      '(6-2)*(3+1)+5'
    ],
    hard: [
      '(3+4)*(5-2)^2',
      '7*(6-4)+3^2',
      '(9-3)*(2+1)^2',
      '8*(5-(3+1))^2',
      '(6/2)*(3^2-1)',
      '9-(3*(2+1)^2)',
      '(4+5)*(6-3^2)',
      '7^2-(3*(4-1))',
      '(8-3)^2+4*2',
      '(5^2-9)/(3-2)'
    ]
  };

  const MAX_ATTEMPTS = 6;

  let secretExpr = '';
  let secretChars = [];
  let digitsSequence = [];
  let targetValue = null;

  let currentRow = 0;
  let gameOver = false;

  let currentDifficulty = 'easy';
  const lastSecretByDifficulty = {
    easy: null,
    medium: null,
    hard: null
  };

  const boardEl = document.getElementById('board');
  const numbersEl = document.getElementById('numbers');
  const targetEl = document.getElementById('target');
  const messageEl = document.getElementById('message');
  const evalInfoEl = document.getElementById('eval-info');
  const guessInput = document.getElementById('guess-input');
  const submitBtn = document.getElementById('submit-btn');
  const newGameBtn = document.getElementById('new-game-btn');
  const diffButtons = document.querySelectorAll('.difficulty-toggle button');

  function randomChoice(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function safeEvaluate(expr) {
    const trimmed = expr.replace(/\s+/g, '');
    if (!/^[0-9+\-*/()^]+$/.test(trimmed)) {
      throw new Error('Unsupported characters');
    }
    const jsExpr = trimmed.replace(/\^/g, '**'); // exponent as JS **
    return Function('"use strict"; return (' + jsExpr + ');')();
  }

  function preparePuzzle() {
    const pool = PUZZLES[currentDifficulty];
    if (!pool || pool.length === 0) {
      console.error('No puzzles for difficulty:', currentDifficulty);
      return;
    }

    // Choose a new puzzle, avoiding immediate repetition for this difficulty
    let expr;
    if (pool.length > 1) {
      do {
        expr = randomChoice(pool);
      } while (expr === lastSecretByDifficulty[currentDifficulty]);
    } else {
      expr = pool[0];
    }
    lastSecretByDifficulty[currentDifficulty] = expr;

    secretExpr = expr.replace(/\s+/g, '');
    secretChars = secretExpr.split('');
    digitsSequence = secretExpr.replace(/[^0-9]/g, '').split('');
    targetValue = null;

    try {
      targetValue = safeEvaluate(secretExpr);
    } catch (e) {
      console.error('Failed to evaluate secret expression:', e);
    }

    numbersEl.textContent = digitsSequence.join(' ');
    targetEl.textContent = (targetValue !== null ? targetValue : '?');

    // Build the empty board
    boardEl.innerHTML = '';
    boardEl.style.gridTemplateRows = `repeat(${MAX_ATTEMPTS}, 1fr)`;
    boardEl.style.gridTemplateColumns = '1fr';

    for (let r = 0; r < MAX_ATTEMPTS; r++) {
      const rowEl = document.createElement('div');
      rowEl.className = 'row';
      rowEl.style.gridTemplateColumns = `repeat(${secretChars.length}, 1fr)`;
      for (let c = 0; c < secretChars.length; c++) {
        const tile = document.createElement('div');
        tile.className = 'tile faded';
        tile.textContent = '';
        rowEl.appendChild(tile);
      }
      boardEl.appendChild(rowEl);
    }

    currentRow = 0;
    gameOver = false;
    messageEl.textContent = '';
    evalInfoEl.textContent = '';
    newGameBtn.classList.add('hidden');
    guessInput.value = '';
    guessInput.disabled = false;
    submitBtn.disabled = false;
    guessInput.focus();
  }

  function setMessage(text, isError = false) {
    messageEl.textContent = text;
    messageEl.style.color = isError ? '#fca5a5' : '#e5e7eb';
    if (isError) {
      boardEl.classList.remove('shake');
      void boardEl.offsetWidth; // restart animation
      boardEl.classList.add('shake');
      setTimeout(() => boardEl.classList.remove('shake'), 300);
    }
  }

  // Animated reveal of the row result
  function revealRow(guess, resultClasses) {
    const rowEl = boardEl.children[currentRow];
    const delayPerTile = 130; // ms per tile

    for (let i = 0; i < secretChars.length; i++) {
      const tile = rowEl.children[i];
      tile.textContent = guess[i] ?? '';
      tile.classList.remove('faded', 'correct', 'present', 'absent', 'reveal');

      setTimeout(() => {
        tile.classList.add('reveal');
        tile.classList.add(resultClasses[i]);
      }, i * delayPerTile);

      setTimeout(() => {
        tile.classList.remove('reveal');
      }, i * delayPerTile + 500);
    }
  }

  function scoreGuess(guess) {
    const guessChars = guess.split('');
    const res = new Array(secretChars.length).fill('absent');
    const used = new Array(secretChars.length).fill(false);

    // Green pass
    for (let i = 0; i < secretChars.length; i++) {
      if (guessChars[i] === secretChars[i]) {
        res[i] = 'correct';
        used[i] = true;
      }
    }
    // Yellow pass
    for (let i = 0; i < secretChars.length; i++) {
      if (res[i] === 'correct') continue;
      const ch = guessChars[i];
      let foundIndex = -1;
      for (let j = 0; j < secretChars.length; j++) {
        if (!used[j] && secretChars[j] === ch) {
          foundIndex = j;
          break;
        }
      }
      if (foundIndex !== -1) {
        res[i] = 'present';
        used[foundIndex] = true;
      }
    }
    return res;
  }

  function validateGuess(rawGuess) {
    const guess = rawGuess.replace(/\s+/g, '');
    if (!guess) {
      throw new Error('Enter an expression first.');
    }
    if (!/^[0-9+\-*/()^]+$/.test(guess)) {
      throw new Error('Use only digits and + - * / ^ ( ).');
    }
    if (guess.length !== secretChars.length) {
      throw new Error(`Expression must be exactly ${secretChars.length} characters long.`);
    }
    const digits = guess.replace(/[^0-9]/g, '').split('');
    if (digits.join('') !== digitsSequence.join('')) {
      throw new Error(`Use the digits in this order exactly: ${digitsSequence.join(' ')}`);
    }
    try {
      safeEvaluate(guess);
    } catch (e) {
      throw new Error('Expression is not valid algebraically.');
    }
    return guess;
  }

  function handleGuess() {
    if (gameOver) return;

    const raw = guessInput.value;
    let guess;
    try {
      guess = validateGuess(raw);
    } catch (e) {
      setMessage(e.message, true);
      return;
    }

    // Show evaluation info
    let value = null;
    try {
      value = safeEvaluate(guess);
    } catch {
      value = null;
    }
    if (value !== null && targetValue !== null) {
      const matches = Math.abs(value - targetValue) < 1e-9;
      evalInfoEl.innerHTML = `Your value: <span class="${matches ? 'good' : 'bad'}">${value}</span> â€” Target: <strong>${targetValue}</strong>`;
    } else {
      evalInfoEl.textContent = '';
    }

    const scoring = scoreGuess(guess);
    revealRow(guess, scoring);

    const isExact = (guess === secretExpr);
    const hitsTarget = (value !== null && targetValue !== null && Math.abs(value - targetValue) < 1e-9);

    if (isExact) {
      setMessage('Perfect! You reconstructed the hidden expression. ðŸŽ‰');
      endGame();
      return;
    }

    if (hitsTarget) {
      setMessage('Math win! You hit the right value with a different valid expression. ðŸ§ âœ¨');
      endGame();
      return;
    }

    currentRow++;

    if (currentRow >= MAX_ATTEMPTS) {
      setMessage(`Out of attempts! The hidden expression was: ${secretExpr}`);
      endGame();
    } else {
      // Pre-fill the input with the previous guess so the user can tweak it
      guessInput.value = guess;
      setMessage('');
      guessInput.focus();
    }
  }

  function endGame() {
    gameOver = true;
    guessInput.disabled = true;
    submitBtn.disabled = true;
    newGameBtn.classList.remove('hidden');
  }

  submitBtn.addEventListener('click', handleGuess);
  guessInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleGuess();
    }
  });
  newGameBtn.addEventListener('click', () => {
    preparePuzzle();
  });

  // Difficulty toggle behavior
  diffButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const diff = btn.getAttribute('data-diff');
      if (diff === currentDifficulty) return;

      currentDifficulty = diff;

      diffButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      preparePuzzle();
    });
  });

  // Start the first puzzle (easy by default)
  preparePuzzle();
</script>
</body>
</html>
